name: Watch wa-js -> Discord (releases + fix commits)

on:
  schedule:
    - cron: "*/30 * * * *"  # a cada 30 min
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  watch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (pra salvar estado)
        uses: actions/checkout@v4

      - name: Instalar jq
        run: sudo apt-get update && sudo apt-get install -y jq

      ############################################################
      # 1) RELEASES
      ############################################################
      - name: Buscar Ãºltimo release do wa-js
        id: rel_fetch
        run: |
          API="https://api.github.com/repos/wppconnect-team/wa-js/releases/latest"
          RESP=$(curl -sS "$API")
          TAG=$(echo "$RESP" | jq -r .tag_name)
          NAME=$(echo "$RESP" | jq -r .name)
          URL=$(echo "$RESP" | jq -r .html_url)
          BODY=$(echo "$RESP" | jq -r .body)
          PUB_RAW=$(echo "$RESP" | jq -r .published_at)

          # epoch (segundos) para usar <t:EPOCH:R>
          PUB_EPOCH=$(date -d "$PUB_RAW" +%s 2>/dev/null || gdate -d "$PUB_RAW" +%s)

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "url=$URL"   >> "$GITHUB_OUTPUT"
          echo "pub_epoch=$PUB_EPOCH" >> "$GITHUB_OUTPUT"

          # corpo bruto (vai ser limpo no passo de postagem)
          {
            echo "body<<EOF"
            echo "$BODY"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: LÃª estado de release salvo
        id: rel_state
        run: |
          mkdir -p .wa-js-state
          echo "last=$(cat .wa-js-state/last_tag 2>/dev/null || echo '')" >> "$GITHUB_OUTPUT"

      - name: Posta no Discord (se release mudou)
        if: steps.rel_fetch.outputs.tag != steps.rel_state.outputs.last && steps.rel_fetch.outputs.tag != 'null'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          TAG='${{ steps.rel_fetch.outputs.tag }}'
          NAME='${{ steps.rel_fetch.outputs.name }}'
          URL='${{ steps.rel_fetch.outputs.url }}'
          PUB_EPOCH='${{ steps.rel_fetch.outputs.pub_epoch }}'
          BODY_RAW='${{ steps.rel_fetch.outputs.body }}'

          # Limpeza do corpo: remove linhas redundantes (nome/versÃ£o), remove cabeÃ§alho "## <tag>", colapsa mÃºltiplas linhas em uma sÃ³
          BODY_CLEAN=$(printf "%s\n" "$BODY_RAW" \
            | sed -E "s/\r//g" \
            | sed -E "/^${TAG//./\\.}\$/Id" \
            | sed -E "/^${NAME//./\\.}\$/Id" \
            | sed -E "s/^##[[:space:]]*${TAG//./\\.}.*//I" \
            | awk 'BEGIN{blank=0} { if(length($0)==0){ if(blank==0){ print ""; blank=1 } } else { print; blank=0 } }')

          # Enxuga espaÃ§os das bordas e limita tamanho
          BODY_TRUNC=$(printf "%s" "$BODY_CLEAN" | sed -E 's/^[[:space:]]+//; s/[[:space:]]+$//' | head -c 1400)

          # Usa printf para criar quebras reais (sem \n literais)
          DESC=$(printf "*Publicado:* <t:%s:R>\n\n**Notas:**\n%s" "$PUB_EPOCH" "$BODY_TRUNC")

          payload=$(jq -n \
            --arg title "ðŸ§© Nova versÃ£o: ${TAG}" \
            --arg url "$URL" \
            --arg desc "$DESC" \
            '{
              username: "Release Watcher",
              embeds: [{
                title: $title,
                url: $url,
                description: $desc,
                color: 5814783,
                footer: { text: "wppconnect-team/wa-js â€¢ release" }
              }]
            }')

          curl -sS -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL"

      - name: Atualiza estado de release
        if: steps.rel_fetch.outputs.tag != steps.rel_state.outputs.last && steps.rel_fetch.outputs.tag != 'null'
        run: |
          echo '${{ steps.rel_fetch.outputs.tag }}' > .wa-js-state/last_tag
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .wa-js-state/last_tag
          git commit -m "chore: wa-js last_tag -> ${{ steps.rel_fetch.outputs.tag }}" || echo "Nada pra commitar (release)"
          git push

      ############################################################
      # 2) FIX COMMITS NA BRANCH main (com bootstrap na 1Âª vez)
      ############################################################
      - name: Ler cursor de commits (ISO)
        id: fix_state
        run: |
          mkdir -p .wa-js-state
          if [[ -f .wa-js-state/last_fix_iso ]]; then
            echo "since=$(cat .wa-js-state/last_fix_iso)" >> "$GITHUB_OUTPUT"
            echo "initial=false" >> "$GITHUB_OUTPUT"
          else
            # sem cursor ainda -> modo bootstrap (deixa since vazio; vamos pegar um lote sem since)
            echo "since=" >> "$GITHUB_OUTPUT"
            echo "initial=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Buscar commits (normal ou bootstrap)
        id: fix_fetch
        run: |
          INITIAL='${{ steps.fix_state.outputs.initial }}'
          SINCE='${{ steps.fix_state.outputs.since }}'

          if [ "$INITIAL" = "true" ]; then
            # Bootstrap: pega um lote recente sem since (atÃ© 100)
            API="https://api.github.com/repos/wppconnect-team/wa-js/commits?sha=main&per_page=100"
            RESP=$(curl -sS "$API")
          else
            API="https://api.github.com/repos/wppconnect-team/wa-js/commits?sha=main&since=${SINCE}"
            RESP=$(curl -sS "$API")
          fi

          # Filtra commits que parecem correÃ§Ãµes
          FILTERED=$(echo "$RESP" | jq -r '
            map({
              sha: .sha,
              url: .html_url,
              msg: .commit.message,
              author: (.commit.author.name // "desconhecido"),
              date_raw: .commit.author.date
            })
            | map(select(.msg | test("(?i)\\bfix|hotfix|bug|patch\\b")))
          ')

          if [ "$INITIAL" = "true" ]; then
            COUNT=$(echo "$FILTERED" | jq 'length')
            if [ "$COUNT" -gt 0 ]; then
              ONE=$(echo "$FILTERED" | jq -c 'max_by(.date_raw)')
              RAW=$(echo "$ONE" | jq -r .date_raw)
              EPOCH=$(date -d "$RAW" +%s 2>/dev/null || gdate -d "$RAW" +%s)
              SHA=$(echo "$ONE" | jq -r .sha | cut -c1-7)
              URL=$(echo "$ONE" | jq -r .url)
              MSG=$(echo "$ONE" | jq -r '.msg | split("\n")[0]')
              AUTHOR=$(echo "$ONE" | jq -r .author)

              SUMMARY=$(printf -- "- \`%s\` â€” %s\nðŸ‘¤ %s â€¢ ðŸ•’ <t:%s:R>\n%s\n\n\n" "$SHA" "$MSG" "$AUTHOR" "$EPOCH" "$URL")
              NEWEST="$RAW"
              BOOT_COUNT=1
            else
              SUMMARY=""
              NEWEST=$(echo "$RESP" | jq -r '(max_by(.commit.author.date) | .commit.author.date) // empty')
              BOOT_COUNT=0
            fi

            {
              echo "count=$BOOT_COUNT"
              echo "summary<<EOF"
              echo "${SUMMARY:-}"
              echo "EOF"
              echo "newest=$NEWEST"
            } >> "$GITHUB_OUTPUT"

          else
            COUNT=$(echo "$FILTERED" | jq 'length')

            SUMMARY=$(
              echo "$FILTERED" | jq -c '.[:5][]' | while read -r row; do
                RAW=$(echo "$row" | jq -r .date_raw)
                EPOCH=$(date -d "$RAW" +%s 2>/dev/null || gdate -d "$RAW" +%s)
                SHA=$(echo "$row" | jq -r .sha | cut -c1-7)
                URL=$(echo "$row" | jq -r .url)
                MSG=$(echo "$row" | jq -r '.msg | split("\n")[0]')
                AUTHOR=$(echo "$row" | jq -r .author)
                printf -- "- \`%s\` â€” %s\nðŸ‘¤ %s â€¢ ðŸ•’ <t:%s:R>\n%s\n\n\n" "$SHA" "$MSG" "$AUTHOR" "$EPOCH" "$URL"
              done
            )

            NEWEST=$(echo "$RESP" | jq -r '(max_by(.commit.author.date) | .commit.author.date) // empty')

            {
              echo "count=$COUNT"
              echo "summary<<EOF"
              echo "${SUMMARY:-}"
              echo "EOF"
              echo "newest=$NEWEST"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Postar no Discord (se houver fix-commits)
        if: steps.fix_fetch.outputs.count != '0'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          COUNT='${{ steps.fix_fetch.outputs.count }}'
          SUMMARY='${{ steps.fix_fetch.outputs.summary }}'

          DESC_HEADER="**â€” Ãšltimos fixes â€”**"
          EXTRA=""
          if [ "$COUNT" -gt 5 ]; then
            EXTRA=$(printf "\nâ€¦e +%s outros" "$((COUNT-5))")
          fi

          DESC=$(printf "%s\n\n%s%s" "$DESC_HEADER" "$SUMMARY" "$EXTRA")

          payload=$(jq -n \
            --arg desc "$DESC" \
            '{
              username: "Fix Watcher",
              embeds: [{
                title: "ðŸ› ï¸ Fix commits detectados na main",
                description: $desc,
                color: 16098851,
                footer: { text: "wppconnect-team/wa-js â€¢ commits" }
              }]
            }')

          curl -sS -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL"

      - name: AvanÃ§ar cursor de commits
        if: steps.fix_fetch.outputs.newest != ''
        run: |
          echo '${{ steps.fix_fetch.outputs.newest }}' > .wa-js-state/last_fix_iso
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .wa-js-state/last_fix_iso
          git commit -m "chore: wa-js last_fix_iso -> ${{ steps.fix_fetch.outputs.newest }}" || echo "Nada pra commitar (commits)"
          git push