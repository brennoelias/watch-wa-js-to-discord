name: Watch wa-js -> Discord (releases + fix commits)

on:
  schedule:
    - cron: "*/30 * * * *"  # a cada 30 min
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  watch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (pra salvar estado)
        uses: actions/checkout@v4

      - name: Instalar jq
        run: sudo apt-get update && sudo apt-get install -y jq

      ############################################################
      # 1) RELEASES
      ############################################################
      - name: Buscar Ãºltimo release do wa-js
        id: rel_fetch
        run: |
          API="https://api.github.com/repos/wppconnect-team/wa-js/releases/latest"
          RESP=$(curl -sS "$API")
          TAG=$(echo "$RESP" | jq -r .tag_name)
          NAME=$(echo "$RESP" | jq -r .name)
          URL=$(echo "$RESP" | jq -r .html_url)
          BODY=$(echo "$RESP" | jq -r .body)
          PUB_EPOCH=$(echo "$RESP" | jq -r '.published_at | fromdate? // empty')

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "url=$URL"   >> "$GITHUB_OUTPUT"
          echo "pub_epoch=$PUB_EPOCH" >> "$GITHUB_OUTPUT"
          {
            echo "body<<EOF"
            echo "$BODY"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: LÃª estado de release salvo
        id: rel_state
        run: |
          mkdir -p .wa-js-state
          echo "last=$(cat .wa-js-state/last_tag 2>/dev/null || echo '')" >> "$GITHUB_OUTPUT"

      - name: Posta no Discord (se release mudou)
        if: steps.rel_fetch.outputs.tag != steps.rel_state.outputs.last && steps.rel_fetch.outputs.tag != 'null'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          TAG='${{ steps.rel_fetch.outputs.tag }}'
          NAME='${{ steps.rel_fetch.outputs.name }}'
          URL='${{ steps.rel_fetch.outputs.url }}'
          PUB_EPOCH='${{ steps.rel_fetch.outputs.pub_epoch }}'
          BODY_RAW='${{ steps.rel_fetch.outputs.body }}'

          # Limpeza do corpo: remove linhas redundantes (nome/versÃ£o), remove cabeÃ§alho "## <tag>", colapsa mÃºltiplas linhas vazias
          BODY_CLEAN=$(printf "%s\n" "$BODY_RAW" \
            | sed -E "s/\r//g" \
            | sed -E "/^${TAG//./\\.}\$/Id" \
            | sed -E "/^${NAME//./\\.}\$/Id" \
            | sed -E "s/^##[[:space:]]*${TAG//./\\.}.*//I" \
            | awk 'BEGIN{blank=0} { if(length($0)==0){ if(blank==0){ print ""; blank=1 } } else { print; blank=0 } }')

          BODY_TRUNC=$(printf "%s" "$BODY_CLEAN" | sed -E 's/^[[:space:]]+//; s/[[:space:]]+$//' | head -c 1400)

          # Usa printf para criar quebras reais (sem \n literais)
          DESC=$(printf "*Publicado:* <t:%s:R>\n\n**Notas:**\n%s" "$PUB_EPOCH" "$BODY_TRUNC")

          payload=$(jq -n \
            --arg title "ðŸ§© Nova versÃ£o: ${TAG}" \
            --arg url "$URL" \
            --arg desc "$DESC" \
            '{
              username: "Release Watcher",
              embeds: [{
                title: $title,
                url: $url,
                description: $desc,
                color: 5814783,
                footer: { text: "wppconnect-team/wa-js â€¢ release" }
              }]
            }')

          curl -sS -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL"

      - name: Atualiza estado de release
        if: steps.rel_fetch.outputs.tag != steps.rel_state.outputs.last && steps.rel_fetch.outputs.tag != 'null'
        run: |
          echo '${{ steps.rel_fetch.outputs.tag }}' > .wa-js-state/last_tag
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .wa-js-state/last_tag
          git commit -m "chore: wa-js last_tag -> ${{ steps.rel_fetch.outputs.tag }}" || echo "Nada pra commitar (release)"
          git push

      ############################################################
      # 2) FIX COMMITS NA BRANCH main (com bootstrap + dedupe)
      ############################################################
      - name: Ler cursor de commits (ISO e SHA)
        id: fix_state
        run: |
          mkdir -p .wa-js-state
          if [[ -f .wa-js-state/last_fix_iso ]]; then
            echo "since=$(cat .wa-js-state/last_fix_iso)" >> "$GITHUB_OUTPUT"
            echo "lastsha=$(cat .wa-js-state/last_fix_sha 2>/dev/null || echo '')" >> "$GITHUB_OUTPUT"
            echo "initial=false" >> "$GITHUB_OUTPUT"
          else
            echo "since=" >> "$GITHUB_OUTPUT"     # bootstrap
            echo "lastsha=" >> "$GITHUB_OUTPUT"
            echo "initial=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Buscar commits (normal ou bootstrap)
        id: fix_fetch
        run: |
          INITIAL='${{ steps.fix_state.outputs.initial }}'
          SINCE='${{ steps.fix_state.outputs.since }}'
          LASTSHA='${{ steps.fix_state.outputs.lastsha }}'

          if [ "$INITIAL" = "true" ]; then
            API="https://api.github.com/repos/wppconnect-team/wa-js/commits?sha=main&per_page=100"
            RESP=$(curl -sS "$API")
          else
            API="https://api.github.com/repos/wppconnect-team/wa-js/commits?sha=main&since=${SINCE}"
            RESP=$(curl -sS "$API")
          fi

          # Extrai commits relevantes e aplica dedupe por ISO e SHA
          FILTERED=$(
            echo "$RESP" | jq -r --arg last "${SINCE}" --arg lastsha "${LASTSHA}" '
              map({
                sha: .sha,
                url: .html_url,
                msg: .commit.message,
                author: (.commit.author.name // "desconhecido"),
                date_raw: .commit.author.date
              })
              | map(select(.msg | test("(?i)\\bfix|hotfix|bug|patch\\b")))
              # estritamente depois do ISO salvo (evita repetir fronteira)
              | map(select(($last == "") or (.date_raw > $last)))
              # e nÃ£o repetir exatamente o Ãºltimo SHA salvo
              | map(select(.sha != $lastsha))
            '
          )

          COUNT=$(echo "$FILTERED" | jq 'length')

          # Monta SUMMARY (atÃ© 5) com timestamp relativo
          SUMMARY=$(
            echo "$FILTERED" | jq -c '.[:5][]' | while read -r row; do
              EPOCH=$(echo "$row" | jq -r '.date_raw | fromdate? // empty')
              SHA=$(echo "$row" | jq -r .sha | cut -c1-7)
              URL=$(echo "$row" | jq -r .url)
              MSG=$(echo "$row" | jq -r '.msg | split("\n")[0]')
              AUTHOR=$(echo "$row" | jq -r .author)
              printf -- "- \`%s\` â€” %s\nðŸ‘¤ %s â€¢ ðŸ•’ <t:%s:R>\n%s\n\n\n" "$SHA" "$MSG" "$AUTHOR" "$EPOCH" "$URL"
            done
          )

          # Pega o commit mais novo retornado (qualquer tipo), e gera ISO +1s pra cursor seguro
          NEWEST_PLUS=$(
            echo "$RESP" | jq -r '
              if type=="array" and (length>0) then
                (max_by(.commit.author.date) | .commit.author.date | fromdate? // empty) as $t
                | if $t then ($t + 1 | todate) else empty end
              else empty end
            ' || echo ""
          )

          # TambÃ©m guarda o SHA mais novo (pra dedupe adicional)
          NEWEST_SHA=$(
            echo "$RESP" | jq -r '
              if type=="array" and (length>0) then
                try (max_by(.commit.author.date) | .sha) catch empty
              else empty end
            ' || echo ""
          )

          {
            echo "count=$COUNT"
            echo "summary<<EOF"
            echo "${SUMMARY:-}"
            echo "EOF"
            echo "newest_plus=$NEWEST_PLUS"
            echo "newest_sha=$NEWEST_SHA"
          } >> "$GITHUB_OUTPUT"

      - name: Postar no Discord (se houver fix-commits)
        if: steps.fix_fetch.outputs.count != '0'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          COUNT='${{ steps.fix_fetch.outputs.count }}'
          SUMMARY='${{ steps.fix_fetch.outputs.summary }}'

          DESC_HEADER="**â€” Ãšltimos fixes â€”**"
          EXTRA=""
          if [ "$COUNT" -gt 5 ]; then
            EXTRA=$(printf "\nâ€¦e +%s outros" "$((COUNT-5))")
          fi
          DESC=$(printf "%s\n\n%s%s" "$DESC_HEADER" "$SUMMARY" "$EXTRA")

          payload=$(jq -n \
            --arg desc "$DESC" \
            '{
              username: "Fix Watcher",
              embeds: [{
                title: "ðŸ› ï¸ Fix commits detectados na main",
                description: $desc,
                color: 16098851,
                footer: { text: "wppconnect-team/wa-js â€¢ commits" }
              }]
            }')

          curl -sS -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL"

      - name: AvanÃ§ar cursor de commits (sempre que houver referÃªncia)
        if: steps.fix_fetch.outputs.newest_plus != '' || steps.fix_fetch.outputs.newest_sha != ''
        run: |
          mkdir -p .wa-js-state
          # Atualiza ISO (cursor +1s) se existir
          if [ -n '${{ steps.fix_fetch.outputs.newest_plus }}' ]; then
            echo '${{ steps.fix_fetch.outputs.newest_plus }}' > .wa-js-state/last_fix_iso
            git add .wa-js-state/last_fix_iso
          fi
          # Atualiza SHA mais novo (para dedupe) se existir
          if [ -n '${{ steps.fix_fetch.outputs.newest_sha }}' ]; then
            echo '${{ steps.fix_fetch.outputs.newest_sha }}' > .wa-js-state/last_fix_sha
            git add .wa-js-state/last_fix_sha
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: update fix cursors (iso+sha)" || echo "Nada pra commitar (commits)"
          git push