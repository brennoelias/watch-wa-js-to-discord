name: Watch wa-js releases -> Discord

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  check-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Instalar jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Buscar último release do wa-js
        id: fetch
        run: |
          API="https://api.github.com/repos/wppconnect-team/wa-js/releases/latest"
          RESP=$(curl -sS "$API")
          TAG=$(echo "$RESP" | jq -r .tag_name)
          NAME=$(echo "$RESP" | jq -r .name)
          URL=$(echo "$RESP" | jq -r .html_url)
          BODY=$(echo "$RESP" | jq -r .body)

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "url=$URL"   >> "$GITHUB_OUTPUT"
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Lê última tag salva
        id: state
        run: |
          mkdir -p .wa-js-state
          if [[ -f .wa-js-state/last_tag ]]; then cat .wa-js-state/last_tag; else echo ""; fi > last
          echo "last=$(cat last)" >> "$GITHUB_OUTPUT"

      - name: Envia mensagem no Discord se mudou
        if: steps.fetch.outputs.tag != steps.state.outputs.last && steps.fetch.outputs.tag != 'null'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          payload=$(jq -n --arg tag "${{ steps.fetch.outputs.tag }}" --arg name "${{ steps.fetch.outputs.name }}" --arg url "${{ steps.fetch.outputs.url }}" --arg body "${{ steps.fetch.outputs.body }}" '
          {
            username: "wa-js Watcher",
            embeds: [{
              title: "Nova versão: \($tag)",
              url: $url,
              description: ($name + "\n\n" + $body),
              color: 5814783
            }]
          }')
          curl -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL"

      - name: Atualiza estado
        if: steps.fetch.outputs.tag != steps.state.outputs.last && steps.fetch.outputs.tag != 'null'
        run: |
          echo "${{ steps.fetch.outputs.tag }}" > .wa-js-state/last_tag
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .wa-js-state/last_tag
          git commit -m "update last_tag"
          git push